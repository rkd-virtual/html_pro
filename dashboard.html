<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        body { margin: 0; background: #fcfcfc; font-family: 'Inter', Arial, sans-serif; color: #151515; }
        .top-bar { background: #ff9800; color: #000; padding: 10px 0; text-align: center; font-size: 1rem; position: relative; }
        .close-btn { position: absolute; right: 24px; top: 10px; border: none; background: transparent; font-size: 1.5rem; color: #000; cursor: pointer; }
        .container { max-width: 1100px; margin: 40px auto; background: transparent; padding: 0 32px 60px 32px; position: relative; }
        .invite-btn { position: absolute; right: 32px; top: 40px; background: #ff9800; color: #000; border: none; padding: 12px 28px; border-radius: 6px; font-size: 1rem; font-weight: 500; cursor: pointer; }
        h1 { margin-top: 0; font-size: 2.5rem; font-weight: 600; margin-bottom: 0.25em; }
        .subtitle { font-size: 1.1rem; color: #2d2d2d; margin-bottom: 40px; font-weight: 500; }
        .section { margin-bottom: 56px; }
        .section-title { display: flex; align-items: center; font-size: 1.13rem; font-weight: 600; margin-bottom: 2px; gap: 7px; }
        .icon { font-size: 1.2rem; vertical-align: middle; }
        .section-desc { color: #7d7d7d; margin-bottom: 16px; margin-left: 2px; }
        .section-desc.small { font-size: 0.95rem; margin-bottom: 16px; }
        .stats-row { display: flex; gap: 32px; margin-bottom: 18px; }
        .stat-card { background: #fff; border-radius: 16px; box-shadow: 0 2px 16px rgba(44, 44, 44, 0.07); padding: 30px 32px 24px 32px; min-width: 330px; display: flex; flex-direction: column; position: relative; }
        .stat-title { color: #252525; font-weight: 500; margin-bottom: 14px; font-size: 1rem; display: flex; align-items: center; gap: 4px; }
        .stat-value { font-size: 2.5rem; font-weight: 500; color: #1a1a1a; margin-bottom: 12px; }
        .view-link { color: #1890ff; text-decoration: none; font-size: 1rem; font-weight: 500; position: absolute; bottom: 18px; right: 32px; }
        .styled-table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 12px; border-radius: 8px; overflow: hidden; }
        .styled-table thead { background: #f9f9f9; }
        .styled-table th, .styled-table td { padding: 16px 12px; text-align: left; font-size: 1rem; }
        .styled-table th { font-weight: 600; }
        .styled-table tbody tr { border-top: 1px solid #ededed; }
        .styled-table tbody tr:last-child { border-bottom: none; }
        .status { padding: 3px 10px 3px 4px; border-radius: 5px; font-weight: 500; display: inline-block; font-size: 1rem; }
        .status.good { color: #16b366; background: #f2fcf7; }
        .status.warning { color: #ff9800; background: #fff9ec; }
        .status.danger { color: #ff4d4f; background: #fff0f0; }
        .insight-row { display: flex; gap: 28px; margin-top: 20px; }
        .insight-card { background: #fff; border-radius: 14px; box-shadow: 0 2px 16px rgba(44,44,44,0.07); padding: 30px 32px 24px 32px; min-width: 265px; flex: 1; display: flex; flex-direction: column; align-items: flex-start; }
        .insight-title { font-weight: 500; margin-bottom: 12px; font-size: 1.07rem; display: flex; align-items: center; gap: 6px; }
        .insight-value { font-size: 2.2rem; font-weight: 500; margin-bottom: 14px; }
        .add-quote-link { color: #1890ff; text-decoration: none; font-size: 1rem; font-weight: 500; margin-top: auto; }
        .dropdown-container { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding: 10px;
        border: 1px solid #f9f2f2; border-radius: 9px; width: 310px; background-color: #ffffff; }
        .dropdown-container label { font-size: 1rem; font-weight: 500; color: #333; }
        .dropdown-container select {
          padding: 8px;
          border-radius: 4px;
          border: 1px solid #f7f7f7;
          font-size: 1rem;
          background-color: #fff;
        }
        .insight-row .insight-card:nth-child(1),
        .insight-row .insight-card:nth-child(2) {
            display: none;
        }
        /* SSR */
        .insight-section {
          font-family: 'Satoshi', sans-serif;
          margin-top: 2rem;
        }
        .summary-title {
          font-size: 1rem;
          margin-bottom: 0.25rem;
        }
        .disclaimer {
          font-size: 0.75rem;
          color: #888;
          margin-bottom: 1rem;
        }
        .card-row {
          display: flex;
          gap: 16px;
          margin-bottom: 20px;
        }
        .card-link {
          flex: 1;
          background: #fff;
          border-radius: 12px;
          padding: 16px;
          /*box-shadow: 0 2px 6px rgba(0,0,0,0.05);*/
          text-decoration: none;
          color: inherit;
          transition: box-shadow 0.2s;
          display: flex;
          flex-direction: column;
          justify-content: space-between;
        }
        .card-link:hover {
          box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .card-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-size: 14px;
          color: #555;
        }
        .card-count {
          font-size: 28px;
          font-weight: bold;
          margin-top: 8px;
        }
        .muted {
          color: #888;
        }
        .cta {
          color: #007bff;
          font-size: 14px;
        }

        @media (max-width: 900px) {
            .container { padding: 0 6vw; }
            .stats-row, .insight-row { flex-direction: column; gap: 18px; }
            .invite-btn { right: 6vw; }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <span>Check out your actionable insights to see if you need to upgrade any of your batteries</span>
        <button class="close-btn">&times;</button>
    </div>
    <div class="container">
        <div class="dropdown-container">
            <label for="amazon-site-dropdown">Select an Account:</label>
            <select id="amazon-site-dropdown" name="amazon-site-dropdown"></select>
        </div>
        <button class="invite-btn">Invite Team</button>
        <h1 id="user-name">Hello, Rupak</h1>
        <p class="subtitle" id="user-role">Developer, Amazon LAX9</p>
        
       <!-- SSR -->
        <div class="insight-section">
          <p class="summary-title">üì¶ <strong>Amazon <span id="site-code-title">ABE</span> Open Quotes and Orders</strong></p>
          <p class="disclaimer">Your pending quotes and orders that have yet to be shipped.</p>
          <div class="card-row">
            <a href="#" class="card-link" id="view-quotes-link">
              <div class="card-header">
                <div>üìÑ <span class="muted">Open Quotes</span></div>
                <div class="cta">View ‚Üí</div>
              </div>
              <div class="card-count" id="open-quotes-count">--</div>
            </a>
            <a href="#" class="card-link" id="view-orders-link">
              <div class="card-header">
                <div>üì¶ <span class="muted">Open Orders</span></div>
                <div class="cta">View ‚Üí</div>
              </div>
              <div class="card-count" id="open-orders-count">--</div>
            </a>
          </div>
        </div>
        <!-- ends -->
        
        <div class="section">
            <div class="section-title">
                <span class="icon">üì¶</span>
                <span id="user-heading2">ABE2 Product Summary</span>
            </div>
            <p class="section-desc small">This data may not be accurate and is for reference only.</p>
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>Product Type</th>
                        <th>Quantity</th>
                    </tr>
                </thead>
                <tbody id="product-summary-tbody">
                    <tr><td>Battery Blade Connector</td><td>30</td></tr>
                    <tr><td>Battery Pogo Connector</td><td>40</td></tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-title">
                <span class="icon">üîã</span>
                <span id="user-heading3">ABE2 Battery Expiration by Batch</span>
            </div>
            <p class="section-desc small">These are the dates your batteries are set to expire.</p>
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>Battery Type</th>
                        <th>Quantity</th>
                        <th>Expiration</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="battery-expiration-tbody">
                    
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <div class="section-title">
                <span class="icon">üìå</span>
                <span>Actionable Insights</span>
            </div>
            <p class="section-desc small">
                Based on the status of your batteries you have, we recommend replacing the following for safety and efficiency.
            </p>
            <div class="insight-row">
                <div class="insight-card">
                    <div class="insight-title"><span class="status danger">&#10006;</span> Expired Batteries</div>
                    <div class="insight-value" id="expired-batteries-value">0</div>
                    <a href="#" class="add-quote-link">Add to Quote &rarr;</a>
                </div>
                <div class="insight-card">
                    <div class="insight-title"><span class="status warning">&#9888;</span> Batteries Expiring Soon</div>
                    <div class="insight-value" id="expiring-batteries-value">0</div>
                    <a href="#" class="add-quote-link">Add to Quote &rarr;</a>
                </div>
                <div class="insight-card" id="insight-cards-row">
                    <!-- <div class="insight-title"><span class="status good">&#10004;</span> No Batteries to Replace</div>
                    <div class="insight-value" id="no-replace-batteries-value">0</div> -->
                </div>
            </div>
        </div>
    </div>
<div id="loader" style="
  display:none; position:fixed; top:0; left:0; width:100vw; height:100vh;
  background:rgba(255,255,255,0.6); z-index:9999; align-items:center; justify-content:center">
  <div style="border: 6px solid #e9e9e9; border-top: 6px solid #ff9800; border-radius: 50%; width: 50px; height: 50px; animation: spin 0.9s linear infinite;"></div>
</div>
<style>
@keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
</style>
<script>
(async () => {

  // The DOMContentLoaded listener was removed. All code now runs in sequence.

  const amazonSites = [
        "Amazon ABE2","Amazon ABE3","Amazon ABE8","Amazon ABQ1","Amazon ABQ2","Amazon ABQ5","Amazon ACY1","Amazon ACY2","Amazon ACY5","Amazon ACY8","Amazon ACY9","Amazon AFW1","Amazon AFW2","Amazon AFW5","Amazon AGS1","Amazon AGS2","Amazon AGS5","Amazon AKC1","Amazon AKH4","Amazon AKR1","Amazon ALB1","Amazon AMA1","Amazon AMZ9","Amazon ATL2","Amazon ATL5","Amazon ATL6","Amazon ATL7","Amazon ATS3","Amazon ATS5","Amazon AUN2","Amazon AUS3","Amazon AUS5","Amazon AUV1","Amazon AVP1","Amazon AVP8","Amazon AVP9","Amazon AZA4","Amazon AZA5","Amazon BAN2","Amazon BDL2","Amazon BDL3","Amazon BDL4","Amazon BDL6","Amazon BDL7","Amazon BDU2","Amazon BFi3","Amazon BFI4","Amazon BFI5","Amazon BFI7","Amazon BFI9","Amazon BFL1","Amazon BFL2","Amazon BHM1","Amazon BJX1","Amazon BLV2","Amazon BNA2","Amazon BNA3","Amazon BNA5","Amazon BNA6","Amazon BNA7","Amazon BNA8","Amazon BNE1","Amazon BOI2","Amazon BOI5","Amazon BOS12","Amazon BOS27","Amazon BOS3","Amazon BOS4","Amazon BTR1","Amazon BUF5","Amazon BUF9","Amazon BUR7","Amazon BWI1","Amazon BWI2","Amazon BWI4","Amazon BWI5","Amazon BWU1","Amazon BWU6","Amazon CAE1","Amazon CAE3","Amazon CAK4","Amazon CDW5","Amazon CHA1","Amazon CHA2","Amazon CHM5","Amazon CLE2","Amazon CLE3","Amazon CLE5","Amazon CLE7","Amazon CLE9","Amazon CLT2","Amazon CLT3","Amazon CLT4","Amazon CLT5","Amazon CLT6","Amazon CLT9","Amazon CMH1","Amazon CMH3","Amazon CMH4","Amazon CMH5","Amazon CNO5","Amazon CNO8","Amazon COS5","Amazon CRG1","Amazon CSG1","Amazon CVG2","Amazon CVG5","Amazon CVG9","Amazon DAB2","Amazon DAE1","Amazon DAE3","Amazon DAL2","Amazon DAL3","Amazon DAL9","Amazon DAU1","Amazon DAU2","Amazon DAZ4","Amazon DBA5","Amazon DBA8","Amazon DBK1","Amazon DBL1","Amazon DBO6","Amazon DBO7","Amazon DBU1","Amazon DBV1","Amazon DCA1","Amazon DCA2","Amazon DCA6","Amazon DCD6","Amazon DCG2","Amazon DCG4","Amazon DCH6","Amazon DCK1","Amazon DCL2","Amazon DCL3","Amazon DCL4","Amazon DCM2","Amazon DCS3","Amazon DCW1","Amazon DCW8","Amazon DDC3","Amazon DDC4","Amazon DDE6","Amazon DDE8","Amazon DDF2","Amazon DDT1","Amazon DEN2","Amazon DEN3","Amazon DEN5","Amazon DEN7","Amazon DEN8","Amazon DET1","Amazon DET2","Amazon DET3","Amazon DET6","Amazon DET7","Amazon DEW5","Amazon DFH3","Amazon DFL4","Amazon DFM3","Amazon DFT4","Amazon DFW5","Amazon DFW6","Amazon DFW7","Amazon DFX3","Amazon DGE"];

      function populateDropdown() {
        const dropdown = document.getElementById("amazon-site-dropdown");
        if (!dropdown) return;       
        dropdown.innerHTML = "";
        // This default option is shown when no value is set
        const defaultOption = document.createElement("option");
        defaultOption.textContent = "Select a site";
        defaultOption.value = "";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        dropdown.appendChild(defaultOption);
        amazonSites.forEach(site => {
          const option = document.createElement("option");
          option.value = site;
          option.textContent = site;
          dropdown.appendChild(option);
        });
      }


  // STEP 1: Populate the dropdown with all site options FIRST.
  populateDropdown();

  // STEP 2: Now that the dropdown has options, we can safely get user data and set its value.
  const { name, role, storedsiteCode: userProfileSiteCode } = getUserFromLocalStorage();
  document.getElementById('user-name').textContent = `Hello, ${name}`;
  if (role) document.getElementById('user-role').textContent = role;

  const params = new URLSearchParams(window.location.search);
  const urlSiteCodeRaw = params.get('site_code') || params.get('siteCode') || '';
  const urlSiteCode = urlSiteCodeRaw ? urlSiteCodeRaw.toUpperCase() : '';

  const siteCodeString = urlSiteCode || userProfileSiteCode;

  let siteCode = '';
  if (siteCodeString) {
      // STEP 3: Set the dropdown's value. This will now work because the options exist.
      document.getElementById("amazon-site-dropdown").value = siteCodeString;

      const parts = siteCodeString.split(' ');
      siteCode = parts[1] || '';
      
      if (siteCode) {
          await loadDashboardData(siteCode);
      }
  } else {
      console.log("No site code found in URL or localStorage. Waiting for user selection.");
  }
  
  // --- END: MODIFIED SECTION ---

  document.querySelector('.close-btn').addEventListener('click', function() {
    document.querySelector('.top-bar').style.display = 'none';
  });

  function showLoader() {
    document.getElementById("loader").style.display = "flex";
  }
  function hideLoader() {
    document.getElementById("loader").style.display = "none";
  }

  async function fetchData(url) {
    showLoader();
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return await response.json();
    } catch (error) {
      console.error('Error fetching data:', error);
      return null;
    } finally {
      hideLoader();
    }
  }

  function getUserFromLocalStorage() {
    try {
      const raw = localStorage.getItem('dashboard');
      if (!raw) return { name: 'Guest', role: '', storedsiteCode: '' };
      const parsed = JSON.parse(raw);
      const userArr = parsed.user;
      const user = Array.isArray(userArr) ? userArr[0] : userArr || {};
      const rawSiteCode = user.sitecode || user.siteCode || '';
      return {
        name: user.name || 'Guest',
        role: user.role || '',
        storedsiteCode: rawSiteCode
      };
    } catch (e) {
      console.warn('Failed to parse dashboard from localStorage', e);
      return { name: 'Guest', role: '', storedsiteCode: '' };
    }
  }
  
  function updateUserSiteCodeInLocalStorage(newSiteCode) {
      try {
          const raw = localStorage.getItem('dashboard');
          if (!raw) {
              console.warn('Dashboard object not found in localStorage. Cannot update site code.');
              return;
          }
          const parsed = JSON.parse(raw);
          
          if (parsed && Array.isArray(parsed.user) && parsed.user.length > 0) {
              parsed.user[0].sitecode = newSiteCode;
          } else {
              console.warn('Dashboard object has an unexpected structure.', parsed);
              return;
          }

          localStorage.setItem('dashboard', JSON.stringify(parsed));
      } catch (e) {
          console.error('Failed to update dashboard sitecode in localStorage', e);
      }
  }

  function formatExpirationYear(year) {
    if (year == null) return 'Unknown';
    return `${year}`;
  }

  async function loadDashboardData(siteCode) {
    const API_URL = `https://dtgproject.onrender.com/api/dashboard?site_code=${encodeURIComponent(siteCode)}`;
    console.log('Fetching from', API_URL);

    const dashboardData = await fetchData(API_URL);
    if (!dashboardData) {
      console.error('Failed to fetch dashboard data. Using fallback values.');
      return;
    }

  /*SSR*/
  let quotes = 0, orders = 0;
  try {
    const resp = await fetch(API_URL);
    if (!resp.ok) throw new Error('API error');
    const data = await resp.json();
    quotes = data.part1?.quotes ?? 0;
    orders = data.part1?.order ?? 0;
  } catch (e) {
    // Fallback
    quotes = 0;
    orders = 0;
  }
  document.getElementById('open-quotes-count').textContent = quotes;
  document.getElementById('open-orders-count').textContent = orders;
  document.getElementById('view-quotes-link').addEventListener('click', function(e) {
    e.preventDefault();
    window.location.href = 'https://www.dtgpower.com/portal/account-orders-quotes?tab=quotes';
  });
  document.getElementById('view-orders-link').addEventListener('click', function(e) {
    e.preventDefault();
    window.location.href = 'https://www.dtgpower.com/portal/account-orders-quotes?tab=orders';
  });
  /*---*/

    document.getElementById('user-role').textContent = `Developer, Amazon ${siteCode}`;
    const h1 = document.getElementById('user-heading1');
    const h2 = document.getElementById('user-heading2');
    const h3 = document.getElementById('user-heading3');
    if (h1) h1.textContent = `Amazon ${siteCode} Open Quotes and Orders`;
    if (h2) h2.textContent = `${siteCode} Product Summary`;
    if (h3) h3.textContent = `${siteCode} Battery Expiration by Batch`;

    //document.getElementById('open-quotes-value').textContent = dashboardData.part1?.quotes ?? 0;
    //document.getElementById('open-orders-value').textContent = dashboardData.part1?.order ?? 0;

    const productSummaryTbody = document.getElementById('product-summary-tbody');
    productSummaryTbody.innerHTML = '';
    (dashboardData.part_2?.product_summary || []).forEach(item => {
      const row = productSummaryTbody.insertRow();
      row.insertCell().textContent = item.type || 'Unknown';
      row.insertCell().textContent = item.quantity != null ? item.quantity : '0';
    });

    const batteryExpirationTbody = document.getElementById('battery-expiration-tbody');
    batteryExpirationTbody.innerHTML = '';
    let expiredCount = 0, expiringSoonCount = 0, goodCount = 0;
    const currentYear = new Date().getFullYear();

    (dashboardData.part_2?.batch_expiry || []).forEach(battery => {
      const row = batteryExpirationTbody.insertRow();
      row.insertCell().textContent = 'Battery';
      row.insertCell().textContent = battery.quantity != null ? battery.quantity : 0;
      row.insertCell().textContent = formatExpirationYear(battery.year);

      let statusClass = '', statusLabel = '', statusIcon = '';
      if (battery.year != null && battery.year < currentYear) {
        statusClass = 'danger'; statusLabel = 'Expired'; statusIcon = '&#10006;';
        expiredCount += battery.quantity || 0;
      } else if (battery.status === 'upgrade') {
        statusClass = 'warning'; statusLabel = 'Upgrade'; statusIcon = '&#9888;';
        expiringSoonCount += battery.quantity || 0;
      } else {
        statusClass = 'good'; statusLabel = 'Good'; statusIcon = '&#10004;';
        goodCount += battery.quantity || 0;
      }
      row.insertCell().innerHTML = `<span class="status ${statusClass}">${statusIcon} ${statusLabel}</span>`;
    });

    const insightRow = document.getElementById('insight-cards-row');
    insightRow.innerHTML = '';

    // Logic: Show either "Expiring Soon" or "No Batteries" only
    const part3 = dashboardData.part_3;
    if (
      part3 &&
      part3.type === 'alert' &&
      typeof part3.text === 'string' &&
      part3.text.toLowerCase().includes('expiring soon') &&
      part3.quantity > 0
    ) {
      // "Batteries Expiring Soon" card with add-to-quote
      const card = document.createElement('div');
      card.className = 'card-link';
      card.innerHTML = `
        <div class="card-header">
          <div>‚ö†Ô∏è <span class="muted">Batteries Expiring Soon</span></div>
          <div class="cta">Add to Quote ‚Üí</div>
        </div>
        <div class="card-count" id="expiring-batteries-qty">${part3.quantity}</div>
      `;
      card.addEventListener('click', function(e) {
        e.preventDefault();
        // Add-to-quote logic
        const qty = part3.quantity;
        if (!qty || qty <= 0) {
          alert('No expiring batteries to add.');
          return;
        }
        const newItem = {
          id: "DTG-P2-NA-1XP-S0",
          partnumber: "DTG-P2-NA-1XP-S0",
          name: "MPower X300 Battery",
          description: "Definitive Battery (Gray) MPower 300 LFP Swappable Battery",
          price: "735.00",
          qty: qty.toString(),
          requiresHardware: ""
        };
        let quoteItems = [];
        try {
          quoteItems = JSON.parse(localStorage.getItem('quoteItems')) || [];
        } catch (e) { quoteItems = []; }
        // Add or update by id
        const idx = quoteItems.findIndex(item => item.id === newItem.id);
        if (idx >= 0) {
          quoteItems[idx] = newItem;
        } else {
          quoteItems.push(newItem);
        }
        localStorage.setItem('quoteItems', JSON.stringify(quoteItems));
        alert('Added to quote!');
      });
      insightRow.appendChild(card);
    } else {
      // "No Batteries to Replace"
      const card = document.createElement('div');
      card.className = 'card-link';
      card.innerHTML = `
        <div class="card-header">
          <div>‚úÖ <span class="muted">No Batteries to Replace</span></div>
        </div>
        <div class="card-count">0</div>
      `;
      insightRow.appendChild(card);
    }
  }

  document.getElementById("amazon-site-dropdown").addEventListener("change", function() {
    const selectedSite = this.value;
    updateUserSiteCodeInLocalStorage(selectedSite);

    const parts = selectedSite.split(' ');
    if (parts.length === 2) {
      loadDashboardData(parts[1]);
    }
  });

})();
</script>

</body>
</html>